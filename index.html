<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Harbor Plan</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Fraunces:wght@400;600;700&family=IBM+Plex+Sans:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
:root {
  --ink: #1e1b16;
  --muted: #5f5a54;
  --paper: #f7f2ea;
  --accent: #d77a61;
  --accent-2: #4c7a72;
  --card: #fffaf2;
  --line: #e3d9cb;
  --shadow: 0 20px 45px rgba(24, 18, 12, 0.12);
}

* {
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: "IBM Plex Sans", "Segoe UI", sans-serif;
  color: var(--ink);
  background: radial-gradient(circle at top, #fff4e1 0%, #f4e7d8 40%, #eadccd 100%);
  min-height: 100vh;
}

h1,
h2,
.eyebrow {
  font-family: "Fraunces", "Georgia", serif;
}

.ambient {
  position: fixed;
  inset: 0;
  background: linear-gradient(130deg, rgba(215, 122, 97, 0.14), rgba(76, 122, 114, 0.18));
  pointer-events: none;
  mix-blend-mode: multiply;
  opacity: 0.6;
}

header.hero {
  display: grid;
  grid-template-columns: minmax(0, 1.2fr) minmax(0, 0.8fr);
  gap: 2.5rem;
  padding: 3rem 6vw 2rem;
}

.hero-text h1 {
  font-size: clamp(2.4rem, 3.2vw, 3.4rem);
  margin-bottom: 1rem;
}

.eyebrow {
  text-transform: uppercase;
  letter-spacing: 0.14em;
  font-size: 0.75rem;
  color: var(--accent-2);
}

.subhead {
  color: var(--muted);
  font-size: 1.1rem;
  line-height: 1.6;
}

.hero-actions {
  display: flex;
  gap: 1rem;
  margin-top: 2rem;
  flex-wrap: wrap;
}

.hero-card {
  background: var(--card);
  border: 1px solid var(--line);
  border-radius: 1.5rem;
  padding: 2rem;
  box-shadow: var(--shadow);
  animation: floatIn 1s ease;
}

main {
  padding: 0 6vw 3rem;
  display: flex;
  flex-direction: column;
  gap: 2rem;
}

.panel {
  background: var(--card);
  border-radius: 1.5rem;
  padding: 1.8rem 2rem;
  border: 1px solid var(--line);
  box-shadow: var(--shadow);
}

.view-switcher {
  background: linear-gradient(140deg, #fff3e6, #f4e7d8);
}

.panel-head {
  display: flex;
  flex-direction: column;
  gap: 0.4rem;
  margin-bottom: 1.5rem;
}

.grid {
  display: grid;
  gap: 2rem;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
}

.toggle {
  display: inline-flex;
  padding: 0.3rem;
  border-radius: 999px;
  background: #f1e4d4;
  gap: 0.2rem;
}

.toggle-btn {
  border: none;
  background: transparent;
  padding: 0.6rem 1.2rem;
  border-radius: 999px;
  cursor: pointer;
  font-weight: 600;
  color: var(--muted);
}

.toggle-btn.active {
  background: var(--accent);
  color: #fff;
}

.tabs {
  display: flex;
  flex-wrap: wrap;
  gap: 0.6rem;
}

.tab {
  border: 1px solid var(--line);
  background: #fff;
  color: var(--muted);
  padding: 0.6rem 1.2rem;
  border-radius: 999px;
  cursor: pointer;
  font-weight: 600;
}

.tab.active {
  background: var(--accent-2);
  color: #fff;
  border-color: transparent;
}

.planner-form {
  display: grid;
  gap: 0.8rem;
}

label {
  display: grid;
  gap: 0.4rem;
  font-weight: 600;
  color: var(--muted);
}

input,
select,
textarea {
  border-radius: 0.9rem;
  border: 1px solid var(--line);
  padding: 0.7rem 0.9rem;
  font-size: 1rem;
  font-family: "IBM Plex Sans", sans-serif;
  background: #fff;
}

textarea {
  resize: vertical;
}

button {
  border: none;
  font-size: 1rem;
  padding: 0.7rem 1.4rem;
  border-radius: 999px;
  cursor: pointer;
  font-weight: 600;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

button:hover {
  transform: translateY(-1px);
  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
}

.primary {
  background: var(--accent);
  color: #fff;
}

.ghost {
  background: transparent;
  border: 1px solid var(--line);
  color: var(--muted);
}

.list {
  display: grid;
  gap: 0.8rem;
  margin-top: 1rem;
}

.list-item {
  border-radius: 1rem;
  border: 1px solid var(--line);
  padding: 0.8rem 1rem;
  background: #fff;
  display: grid;
  gap: 0.4rem;
}

.list-item small {
  color: var(--muted);
}

.list-item .meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 0.6rem;
}

.action-buttons {
  display: flex;
  align-items: center;
  gap: 0.4rem;
}

.list-item button {
  padding: 0.3rem 0.8rem;
  font-size: 0.85rem;
  background: #f3e6d7;
  color: var(--muted);
}

.list-item .remove-btn {
  background: transparent;
  border: none;
  color: var(--muted);
  font-weight: 700;
  padding: 0.1rem 0.4rem;
  line-height: 1;
  border-radius: 999px;
}

.list-item .remove-btn:hover {
  background: #f1e4d4;
}

.panel-actions {
  display: flex;
  gap: 1rem;
  align-items: center;
  margin-top: 1rem;
}

.status {
  color: var(--muted);
  font-size: 0.9rem;
}

.summary {
  display: grid;
  gap: 0.6rem;
}

.summary-item {
  display: flex;
  justify-content: space-between;
  font-weight: 600;
}

.safety {
  background: linear-gradient(130deg, #fff7ee, #f2e7da);
}

.safety-grid {
  display: grid;
  gap: 1rem;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  margin-top: 1rem;
}

.week-grid {
  display: grid;
  gap: 1rem;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
}

.week-day {
  border-radius: 1rem;
  border: 1px solid var(--line);
  padding: 1rem;
  background: #fff;
  display: grid;
  gap: 0.6rem;
}

.week-day h3 {
  margin: 0;
  font-size: 1.1rem;
}

.week-day ul {
  list-style: none;
  margin: 0;
  padding: 0;
  display: grid;
  gap: 0.4rem;
  font-size: 0.95rem;
  color: var(--muted);
}

.routine-grid {
  display: grid;
  gap: 1.2rem;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
}

.routine-card {
  border-radius: 1.2rem;
  border: 1px solid var(--line);
  padding: 1.2rem;
  background: #fff;
  display: grid;
  gap: 0.6rem;
}

.routine-card h3 {
  margin: 0;
}

.routine-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 0.6rem;
  align-items: center;
}

footer {
  padding: 2rem 6vw 3rem;
  color: var(--muted);
  font-size: 0.95rem;
}

.simple-mode .planner-form,
.simple-mode .panel-actions,
.simple-mode textarea,
.simple-mode .safety {
  display: none;
}

.simple-mode .view[data-view="week"],
.simple-mode .view[data-view="routines"],
.simple-mode .view[data-view="meds"],
.simple-mode .view[data-view="handoff"] {
  display: none;
}

.simple-mode .list-item button {
  display: none;
}

.view-hidden {
  display: none;
}

@keyframes floatIn {
  from {
    transform: translateY(20px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

@media (max-width: 960px) {
  header.hero {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 600px) {
  header.hero,
  main {
    padding: 2rem 1.4rem;
  }
}

@media print {
  .hero-actions,
  .toggle,
  button,
  .ambient {
    display: none !important;
  }

  body {
    background: #fff;
  }
}

    </style>
  </head>
  <body>
    <div class="ambient"></div>
    <header class="hero">
      <div class="hero-text">
        <p class="eyebrow">Harbor Plan</p>
        <h1>Calm, clear routines for meals and movement.</h1>
        <p class="subhead">
          Plan a day that supports memory, energy, and dignity. Designed for caregivers and
          people living with Alzheimer’s.
        </p>
        <div class="hero-actions">
          <button id="printPlan" class="primary">Print or save today</button>
          <button id="resetPlan" class="ghost">Start a new day</button>
        </div>
      </div>
      <div class="hero-card">
        <h2>Today at a glance</h2>
        <div class="summary" id="summary"></div>
      </div>
    </header>

    <main>
      <section class="panel view-switcher">
        <div class="panel-head">
          <h2>Views</h2>
          <p>Jump between today, week, routines, medication, and handoff.</p>
        </div>
        <div class="tabs" id="viewTabs">
          <button class="tab active" data-view="today">Today</button>
          <button class="tab" data-view="week">Week</button>
          <button class="tab" data-view="routines">Routines</button>
          <button class="tab" data-view="meds">Medication</button>
          <button class="tab" data-view="handoff">Handoff</button>
        </div>
      </section>

      <section class="panel">
        <div class="panel-head">
          <h2>Who is this plan for?</h2>
          <p>Switch between caregiver detail view and a simplified view.</p>
        </div>
        <div class="toggle">
          <button class="toggle-btn active" data-mode="caregiver">Caregiver view</button>
          <button class="toggle-btn" data-mode="patient">Simple view</button>
        </div>
      </section>

      <section class="grid view" data-view="today">
        <div class="panel">
          <div class="panel-head">
            <h2>Meals</h2>
            <p>Small, regular meals with hydration cues.</p>
          </div>
          <form id="mealForm" class="planner-form">
            <label>
              Meal name
              <input type="text" name="title" placeholder="Breakfast: oatmeal & berries" required />
            </label>
            <label>
              Time
              <input type="time" name="time" required />
            </label>
            <label>
              Day
              <select name="day" class="day-select" required>
                <option value="0">Sunday</option>
                <option value="1">Monday</option>
                <option value="2">Tuesday</option>
                <option value="3">Wednesday</option>
                <option value="4">Thursday</option>
                <option value="5">Friday</option>
                <option value="6">Saturday</option>
              </select>
            </label>
            <label>
              Support note
              <input type="text" name="notes" placeholder="Warm tea, cut fruit, gentle prompt" />
            </label>
            <button type="submit" class="primary">Add meal</button>
          </form>
          <div id="mealList" class="list"></div>
        </div>

        <div class="panel">
          <div class="panel-head">
            <h2>Movement</h2>
            <p>Light activity that feels safe and familiar.</p>
          </div>
          <form id="exerciseForm" class="planner-form">
            <label>
              Activity
              <input type="text" name="title" placeholder="10 min walk in the garden" required />
            </label>
            <label>
              Time
              <input type="time" name="time" required />
            </label>
            <label>
              Day
              <select name="day" class="day-select" required>
                <option value="0">Sunday</option>
                <option value="1">Monday</option>
                <option value="2">Tuesday</option>
                <option value="3">Wednesday</option>
                <option value="4">Thursday</option>
                <option value="5">Friday</option>
                <option value="6">Saturday</option>
              </select>
            </label>
            <label>
              Support note
              <input type="text" name="notes" placeholder="Bring water, walk together" />
            </label>
            <button type="submit" class="primary">Add activity</button>
          </form>
          <div id="exerciseList" class="list"></div>
        </div>
      </section>

      <section class="grid view" data-view="today">
        <div class="panel">
          <div class="panel-head">
            <h2>Gentle reminders</h2>
            <p>Simple prompts to keep the day anchored.</p>
          </div>
          <form id="reminderForm" class="planner-form">
            <label>
              Reminder
              <input type="text" name="title" placeholder="Hydration check" required />
            </label>
            <label>
              Time
              <input type="time" name="time" required />
            </label>
            <label>
              Day
              <select name="day" class="day-select" required>
                <option value="0">Sunday</option>
                <option value="1">Monday</option>
                <option value="2">Tuesday</option>
                <option value="3">Wednesday</option>
                <option value="4">Thursday</option>
                <option value="5">Friday</option>
                <option value="6">Saturday</option>
              </select>
            </label>
            <label>
              Tone
              <select name="tone">
                <option value="gentle">Gentle</option>
                <option value="encouraging">Encouraging</option>
                <option value="firm">Firm</option>
              </select>
            </label>
            <button type="submit" class="primary">Add reminder</button>
          </form>
          <div id="reminderList" class="list"></div>
        </div>

        <div class="panel">
          <div class="panel-head">
            <h2>Caregiver notes</h2>
            <p>Capture cues, stressors, and wins.</p>
          </div>
          <textarea id="careNotes" rows="10" placeholder="Example: Best energy after breakfast. Prefers music during walk."></textarea>
          <div class="panel-actions">
            <button id="saveNotes" class="primary">Save notes</button>
            <span id="saveStatus" class="status">Not saved</span>
          </div>
        </div>
      </section>

      <section class="panel safety view" data-view="today">
        <div>
          <h2>Safety quick check</h2>
          <p>Keep these visible for anyone stepping in to help.</p>
        </div>
        <div class="safety-grid">
          <label>
            Preferred foods
            <input type="text" id="prefFoods" placeholder="Soft foods, warm meals" />
          </label>
          <label>
            Foods to avoid
            <input type="text" id="avoidFoods" placeholder="Sticky textures" />
          </label>
          <label>
            Mobility notes
            <input type="text" id="mobilityNotes" placeholder="Use walker, steady pace" />
          </label>
          <label>
            Emergency contact
            <input type="text" id="emergencyContact" placeholder="Name + phone" />
          </label>
        </div>
      </section>

      <section class="panel view" data-view="week">
        <div class="panel-head">
          <h2>Week overview</h2>
          <p>Scan the full week by day and by type.</p>
        </div>
        <div id="weekView" class="week-grid"></div>
      </section>

      <section class="panel view" data-view="routines">
        <div class="panel-head">
          <h2>Routine library</h2>
          <p>Drop in gentle, familiar sequences with one click.</p>
        </div>
        <div class="routine-grid" id="routineGrid">
          <article class="routine-card" data-routine="gentle-morning">
            <h3>Gentle morning</h3>
            <p>Breakfast, hydration, and a light stretch.</p>
            <div class="routine-actions">
              <select class="routine-day">
                <option value="0">Sunday</option>
                <option value="1">Monday</option>
                <option value="2">Tuesday</option>
                <option value="3">Wednesday</option>
                <option value="4">Thursday</option>
                <option value="5">Friday</option>
                <option value="6">Saturday</option>
              </select>
              <button class="ghost routine-add" type="button">Add to day</button>
            </div>
          </article>
          <article class="routine-card" data-routine="midday-move">
            <h3>Midday movement</h3>
            <p>Walk, balance check, and a snack.</p>
            <div class="routine-actions">
              <select class="routine-day">
                <option value="0">Sunday</option>
                <option value="1">Monday</option>
                <option value="2">Tuesday</option>
                <option value="3">Wednesday</option>
                <option value="4">Thursday</option>
                <option value="5">Friday</option>
                <option value="6">Saturday</option>
              </select>
              <button class="ghost routine-add" type="button">Add to day</button>
            </div>
          </article>
          <article class="routine-card" data-routine="evening-winddown">
            <h3>Evening wind-down</h3>
            <p>Soft dinner, calm reminder, and soothing music.</p>
            <div class="routine-actions">
              <select class="routine-day">
                <option value="0">Sunday</option>
                <option value="1">Monday</option>
                <option value="2">Tuesday</option>
                <option value="3">Wednesday</option>
                <option value="4">Thursday</option>
                <option value="5">Friday</option>
                <option value="6">Saturday</option>
              </select>
              <button class="ghost routine-add" type="button">Add to day</button>
            </div>
          </article>
        </div>
      </section>

      <section class="panel view" data-view="meds">
        <div class="panel-head">
          <h2>Medication schedule</h2>
          <p>Track meds alongside meals to reduce missed doses.</p>
        </div>
        <form id="medForm" class="planner-form">
          <label>
            Medication
            <input type="text" name="title" placeholder="Donepezil" required />
          </label>
          <label>
            Time
            <input type="time" name="time" required />
          </label>
          <label>
            Dosage
            <input type="text" name="dosage" placeholder="5 mg" />
          </label>
          <label>
            Day
            <select name="day" class="day-select" required>
              <option value="0">Sunday</option>
              <option value="1">Monday</option>
              <option value="2">Tuesday</option>
              <option value="3">Wednesday</option>
              <option value="4">Thursday</option>
              <option value="5">Friday</option>
              <option value="6">Saturday</option>
            </select>
          </label>
          <label>
            Instructions
            <input type="text" name="notes" placeholder="With food, full glass of water" />
          </label>
          <button type="submit" class="primary">Add medication</button>
        </form>
        <div id="medList" class="list"></div>
        <div class="panel-actions">
          <button id="enableAlerts" class="ghost" type="button">Enable alerts</button>
          <span id="alertStatus" class="status">Alerts off</span>
        </div>
        <p class="status">Alerts work while this page stays open.</p>
      </section>

      <section class="panel view" data-view="handoff">
        <div class="panel-head">
          <h2>Caregiver handoff</h2>
          <p>Share a clear summary for the next shift.</p>
        </div>
        <textarea id="handoffText" rows="12" readonly></textarea>
        <div class="panel-actions">
          <button id="copyHandoff" class="primary" type="button">Copy summary</button>
          <button id="printHandoff" class="ghost" type="button">Print summary</button>
        </div>
      </section>
    </main>

    <footer>
      <p>
        Harbor Plan is a planning helper and does not replace medical advice. For safety concerns,
        check with a clinician.
      </p>
    </footer>

    <script>
const STORAGE_KEY = "harbor-plan-data";
const DAYS = [
  "Sunday",
  "Monday",
  "Tuesday",
  "Wednesday",
  "Thursday",
  "Friday",
  "Saturday",
];

function getTodayIndex() {
  return new Date().getDay();
}

function createDefaultData() {
  const today = getTodayIndex();
  return {
    meals: [
      {
        id: crypto.randomUUID(),
        title: "Breakfast: oatmeal & berries",
        time: "08:00",
        notes: "Warm tea, gentle prompt",
        day: today,
      },
    ],
    exercises: [
      {
        id: crypto.randomUUID(),
        title: "10 min walk in the garden",
        time: "10:30",
        notes: "Bring water, walk together",
        day: today,
      },
    ],
    reminders: [
      {
        id: crypto.randomUUID(),
        title: "Hydration check",
        time: "09:30",
        tone: "gentle",
        day: today,
      },
    ],
    meds: [],
    notes: "",
    safety: {
      prefFoods: "",
      avoidFoods: "",
      mobilityNotes: "",
      emergencyContact: "",
    },
    mode: "caregiver",
    view: "today",
    alertsEnabled: false,
  };
}

const routines = {
  "gentle-morning": {
    meals: [
      {
        title: "Breakfast: warm cereal",
        time: "08:00",
        notes: "Serve warm, offer tea",
      },
    ],
    reminders: [
      {
        title: "Hydration reminder",
        time: "08:45",
        tone: "gentle",
      },
    ],
    exercises: [
      {
        title: "5 min stretch together",
        time: "09:15",
        notes: "Slow pace, chair nearby",
      },
    ],
  },
  "midday-move": {
    meals: [
      {
        title: "Midday snack",
        time: "12:00",
        notes: "Soft fruit or yogurt",
      },
    ],
    exercises: [
      {
        title: "15 min walk",
        time: "11:15",
        notes: "Bring water, shade if needed",
      },
    ],
    reminders: [
      {
        title: "Rest and breathe",
        time: "12:30",
        tone: "encouraging",
      },
    ],
  },
  "evening-winddown": {
    meals: [
      {
        title: "Dinner: comforting soup",
        time: "18:00",
        notes: "Soft textures, warm broth",
      },
    ],
    reminders: [
      {
        title: "Calm music",
        time: "19:00",
        tone: "gentle",
      },
    ],
  },
};

let state = loadState();
let alertTimers = [];

const mealForm = document.getElementById("mealForm");
const exerciseForm = document.getElementById("exerciseForm");
const reminderForm = document.getElementById("reminderForm");
const medForm = document.getElementById("medForm");
const mealList = document.getElementById("mealList");
const exerciseList = document.getElementById("exerciseList");
const reminderList = document.getElementById("reminderList");
const medList = document.getElementById("medList");
const summary = document.getElementById("summary");
const careNotes = document.getElementById("careNotes");
const saveNotes = document.getElementById("saveNotes");
const saveStatus = document.getElementById("saveStatus");
const printPlan = document.getElementById("printPlan");
const resetPlan = document.getElementById("resetPlan");
const toggleButtons = document.querySelectorAll(".toggle-btn");
const viewTabs = document.querySelectorAll(".tab");
const views = document.querySelectorAll(".view");
const weekView = document.getElementById("weekView");
const routineGrid = document.getElementById("routineGrid");
const handoffText = document.getElementById("handoffText");
const copyHandoff = document.getElementById("copyHandoff");
const printHandoff = document.getElementById("printHandoff");
const enableAlerts = document.getElementById("enableAlerts");
const alertStatus = document.getElementById("alertStatus");

const safetyFields = {
  prefFoods: document.getElementById("prefFoods"),
  avoidFoods: document.getElementById("avoidFoods"),
  mobilityNotes: document.getElementById("mobilityNotes"),
  emergencyContact: document.getElementById("emergencyContact"),
};

function loadState() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return createDefaultData();
  try {
    const parsed = JSON.parse(raw);
    return normalizeState({ ...createDefaultData(), ...parsed });
  } catch (error) {
    return createDefaultData();
  }
}

function normalizeState(current) {
  const today = getTodayIndex();
  current.meals = current.meals.map((item) => ({ ...item, day: item.day ?? today }));
  current.exercises = current.exercises.map((item) => ({ ...item, day: item.day ?? today }));
  current.reminders = current.reminders.map((item) => ({ ...item, day: item.day ?? today }));
  current.meds = current.meds?.map((item) => ({ ...item, day: item.day ?? today })) || [];
  current.alertsEnabled = Boolean(current.alertsEnabled);
  return current;
}

function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function sortByTime(items) {
  return [...items].sort((a, b) => a.time.localeCompare(b.time));
}

function formatTime(timeString) {
  if (!timeString) return "";
  const [hour, minute] = timeString.split(":");
  const date = new Date();
  date.setHours(Number(hour));
  date.setMinutes(Number(minute));
  return date.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });
}

function buildItemDetails(item) {
  const details = [];
  if (item.dosage) details.push(item.dosage);
  if (item.notes) details.push(item.notes);
  if (item.tone) details.push(`${item.tone} tone`);
  return details.join(" · ");
}

function renderList(listElement, items, type, listKey) {
  listElement.innerHTML = "";
  if (!items.length) {
    const empty = document.createElement("p");
    empty.className = "status";
    empty.textContent = `No ${type} planned yet.`;
    listElement.appendChild(empty);
    return;
  }

  sortByTime(items).forEach((item) => {
    const wrapper = document.createElement("div");
    wrapper.className = "list-item";

    const title = document.createElement("strong");
    title.textContent = item.title;

    const meta = document.createElement("div");
    meta.className = "meta";

    const time = document.createElement("small");
    time.textContent = `${formatTime(item.time)} · ${DAYS[item.day]}`;

    const button = document.createElement("button");
    button.textContent = "Mark done";
    button.addEventListener("click", () => {
      wrapper.style.opacity = 0.55;
    });

    const removeButton = document.createElement("button");
    removeButton.type = "button";
    removeButton.className = "remove-btn";
    removeButton.textContent = "x";
    removeButton.setAttribute("aria-label", `Remove ${item.title}`);
    removeButton.addEventListener("click", () => {
      state[listKey] = state[listKey].filter((entry) => entry.id !== item.id);
      saveState();
      renderAll();
    });

    const actionGroup = document.createElement("div");
    actionGroup.className = "action-buttons";
    actionGroup.appendChild(button);
    actionGroup.appendChild(removeButton);

    meta.appendChild(time);
    meta.appendChild(actionGroup);

    const notes = document.createElement("small");
    notes.textContent = buildItemDetails(item);

    wrapper.appendChild(title);
    wrapper.appendChild(meta);
    if (notes.textContent) wrapper.appendChild(notes);

    listElement.appendChild(wrapper);
  });
}

function renderSummary() {
  summary.innerHTML = "";
  const totalMeals = state.meals.length;
  const totalExercises = state.exercises.length;
  const totalReminders = state.reminders.length;
  const totalMeds = state.meds.length;

  const data = [
    { label: "Meals", value: totalMeals },
    { label: "Activities", value: totalExercises },
    { label: "Reminders", value: totalReminders },
    { label: "Meds", value: totalMeds },
  ];

  data.forEach((item) => {
    const row = document.createElement("div");
    row.className = "summary-item";
    row.innerHTML = `<span>${item.label}</span><span>${item.value}</span>`;
    summary.appendChild(row);
  });
}

function renderNotes() {
  careNotes.value = state.notes;
  Object.entries(safetyFields).forEach(([key, field]) => {
    field.value = state.safety[key] || "";
  });
}

function renderWeek() {
  weekView.innerHTML = "";
  DAYS.forEach((day, index) => {
    const items = [
      ...state.meals.map((item) => ({ ...item, type: "Meal" })),
      ...state.exercises.map((item) => ({ ...item, type: "Activity" })),
      ...state.reminders.map((item) => ({ ...item, type: "Reminder" })),
      ...state.meds.map((item) => ({ ...item, type: "Medication" })),
    ].filter((item) => item.day === index);

    const card = document.createElement("div");
    card.className = "week-day";

    const title = document.createElement("h3");
    title.textContent = day;

    const list = document.createElement("ul");
    if (!items.length) {
      const empty = document.createElement("li");
      empty.textContent = "No plans yet.";
      list.appendChild(empty);
    } else {
      sortByTime(items).forEach((item) => {
        const li = document.createElement("li");
        li.textContent = `${formatTime(item.time)} · ${item.type}: ${item.title}`;
        list.appendChild(li);
      });
    }

    card.appendChild(title);
    card.appendChild(list);
    weekView.appendChild(card);
  });
}

function setMode(mode) {
  state.mode = mode;
  document.body.classList.toggle("simple-mode", mode === "patient");
  toggleButtons.forEach((button) => {
    button.classList.toggle("active", button.dataset.mode === mode);
  });
  if (mode === "patient") {
    setView("today");
  }
  saveState();
}

function setView(view) {
  const desired = state.mode === "patient" && view !== "today" ? "today" : view;
  state.view = desired;
  viewTabs.forEach((button) => {
    button.classList.toggle("active", button.dataset.view === desired);
  });
  views.forEach((section) => {
    const matches = section.dataset.view === desired;
    section.classList.toggle("view-hidden", !matches);
  });
  saveState();
}

function handleSubmit(form, listKey) {
  const formData = new FormData(form);
  const entry = Object.fromEntries(formData.entries());
  entry.id = crypto.randomUUID();
  entry.day = Number(entry.day);
  state[listKey].push(entry);
  saveState();
  renderAll();
  form.reset();
  setDaySelectDefaults();
}

function setDaySelectDefaults() {
  const today = String(getTodayIndex());
  document.querySelectorAll(".day-select").forEach((select) => {
    select.value = today;
  });
  document.querySelectorAll(".routine-day").forEach((select) => {
    select.value = today;
  });
}

function buildHandoff() {
  const todayIndex = getTodayIndex();
  const todayLabel = DAYS[todayIndex];
  const todayItems = {
    meals: state.meals.filter((item) => item.day === todayIndex),
    exercises: state.exercises.filter((item) => item.day === todayIndex),
    reminders: state.reminders.filter((item) => item.day === todayIndex),
    meds: state.meds.filter((item) => item.day === todayIndex),
  };

  const lines = [];
  lines.push(`Harbor Plan handoff - ${todayLabel}`);
  lines.push("");
  lines.push("Meals:");
  lines.push(...formatHandoffList(todayItems.meals));
  lines.push("");
  lines.push("Activities:");
  lines.push(...formatHandoffList(todayItems.exercises));
  lines.push("");
  lines.push("Reminders:");
  lines.push(...formatHandoffList(todayItems.reminders));
  lines.push("");
  lines.push("Medication:");
  lines.push(...formatHandoffList(todayItems.meds));
  lines.push("");
  lines.push("Care notes:");
  lines.push(state.notes ? state.notes : "No notes yet.");
  lines.push("");
  lines.push("Safety quick check:");
  lines.push(`Preferred foods: ${state.safety.prefFoods || ""}`);
  lines.push(`Foods to avoid: ${state.safety.avoidFoods || ""}`);
  lines.push(`Mobility notes: ${state.safety.mobilityNotes || ""}`);
  lines.push(`Emergency contact: ${state.safety.emergencyContact || ""}`);

  return lines.join("\n");
}

function formatHandoffList(items) {
  if (!items.length) return ["- None scheduled."];
  return sortByTime(items).map((item) => {
    const details = [item.title];
    if (item.dosage) details.push(item.dosage);
    if (item.notes) details.push(item.notes);
    if (item.tone) details.push(`${item.tone} tone`);
    return `- ${formatTime(item.time)}: ${details.join(" · ")}`;
  });
}

function renderAll() {
  renderList(mealList, state.meals, "meals", "meals");
  renderList(exerciseList, state.exercises, "activities", "exercises");
  renderList(reminderList, state.reminders, "reminders", "reminders");
  renderList(medList, state.meds, "medications", "meds");
  renderSummary();
  renderNotes();
  renderWeek();
  handoffText.value = buildHandoff();
  setMode(state.mode);
  setView(state.view || "today");
  updateAlertStatus();
  scheduleAlerts();
  setDaySelectDefaults();
}

function addRoutine(routineId, day) {
  const routine = routines[routineId];
  if (!routine) return;
  const dayValue = Number(day);

  routine.meals?.forEach((item) => {
    state.meals.push({ ...item, day: dayValue, id: crypto.randomUUID() });
  });
  routine.exercises?.forEach((item) => {
    state.exercises.push({ ...item, day: dayValue, id: crypto.randomUUID() });
  });
  routine.reminders?.forEach((item) => {
    state.reminders.push({ ...item, day: dayValue, id: crypto.randomUUID() });
  });
  routine.meds?.forEach((item) => {
    state.meds.push({ ...item, day: dayValue, id: crypto.randomUUID() });
  });
  saveState();
  renderAll();
}

function requestAlerts() {
  if (!("Notification" in window)) {
    alert("Notifications are not supported in this browser.");
    return;
  }
  Notification.requestPermission().then((permission) => {
    if (permission !== "granted") {
      state.alertsEnabled = false;
      updateAlertStatus();
      saveState();
      return;
    }
    state.alertsEnabled = true;
    saveState();
    updateAlertStatus();
    scheduleAlerts();
  });
}

function updateAlertStatus() {
  alertStatus.textContent = state.alertsEnabled ? "Alerts on" : "Alerts off";
  enableAlerts.textContent = state.alertsEnabled ? "Refresh alerts" : "Enable alerts";
}

function scheduleAlerts() {
  alertTimers.forEach((timer) => clearTimeout(timer));
  alertTimers = [];
  if (!state.alertsEnabled) return;
  if (!("Notification" in window) || Notification.permission !== "granted") {
    state.alertsEnabled = false;
    updateAlertStatus();
    saveState();
    return;
  }

  const todayIndex = getTodayIndex();
  const now = new Date();

  const events = [
    ...state.meals.map((item) => ({ ...item, label: "Meal" })),
    ...state.exercises.map((item) => ({ ...item, label: "Activity" })),
    ...state.reminders.map((item) => ({ ...item, label: "Reminder" })),
    ...state.meds.map((item) => ({ ...item, label: "Medication" })),
  ].filter((item) => item.day === todayIndex);

  events.forEach((event) => {
    const [hour, minute] = event.time.split(":").map(Number);
    const target = new Date();
    target.setHours(hour, minute, 0, 0);
    const delay = target.getTime() - now.getTime();
    if (delay <= 0) return;

    const timer = setTimeout(() => {
      new Notification(`${event.label}: ${event.title}`, {
        body: event.notes || event.dosage || "",
      });
    }, delay);

    alertTimers.push(timer);
  });
}

mealForm.addEventListener("submit", (event) => {
  event.preventDefault();
  handleSubmit(mealForm, "meals");
});

exerciseForm.addEventListener("submit", (event) => {
  event.preventDefault();
  handleSubmit(exerciseForm, "exercises");
});

reminderForm.addEventListener("submit", (event) => {
  event.preventDefault();
  handleSubmit(reminderForm, "reminders");
});

medForm.addEventListener("submit", (event) => {
  event.preventDefault();
  handleSubmit(medForm, "meds");
});

saveNotes.addEventListener("click", () => {
  state.notes = careNotes.value.trim();
  Object.entries(safetyFields).forEach(([key, field]) => {
    state.safety[key] = field.value.trim();
  });
  saveState();
  saveStatus.textContent = `Saved at ${new Date().toLocaleTimeString([], {
    hour: "numeric",
    minute: "2-digit",
  })}`;
  handoffText.value = buildHandoff();
});

printPlan.addEventListener("click", () => {
  window.print();
});

resetPlan.addEventListener("click", () => {
  if (!confirm("Start a new day? This clears today’s plan.")) return;
  Object.assign(state, createDefaultData());
  saveState();
  renderAll();
  saveStatus.textContent = "Not saved";
});

toggleButtons.forEach((button) => {
  button.addEventListener("click", () => {
    setMode(button.dataset.mode);
  });
});

viewTabs.forEach((button) => {
  button.addEventListener("click", () => {
    setView(button.dataset.view);
  });
});

routineGrid.addEventListener("click", (event) => {
  const addButton = event.target.closest(".routine-add");
  if (!addButton) return;
  const card = addButton.closest(".routine-card");
  const routineId = card.dataset.routine;
  const daySelect = card.querySelector(".routine-day");
  addRoutine(routineId, daySelect.value);
});

enableAlerts.addEventListener("click", () => {
  if (state.alertsEnabled) {
    scheduleAlerts();
    alertStatus.textContent = "Alerts refreshed";
    return;
  }
  requestAlerts();
});

copyHandoff.addEventListener("click", async () => {
  try {
    await navigator.clipboard.writeText(handoffText.value);
    copyHandoff.textContent = "Copied!";
    setTimeout(() => {
      copyHandoff.textContent = "Copy summary";
    }, 1500);
  } catch (error) {
    alert("Unable to copy. You can select and copy manually.");
  }
});

printHandoff.addEventListener("click", () => {
  setView("handoff");
  window.print();
});

setDaySelectDefaults();
renderAll();

    </script>
  </body>
</html>
